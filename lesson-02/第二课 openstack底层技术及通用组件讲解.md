# 第二课 openstack底层技术及通用组件讲解
## 1.计算虚拟化相关技术介绍
### CPU特权级
CPU指中央处理器，是一台电脑上最核心的组件，它的功能主要是解释计算机的指令以及处理计算机软件中的数据，在操作系统中做的任何操作，比如打开一个网页或world 文档之类的操作，落到底层时都需要CPU进行计算处理，而这样的操作显然不能随便让哪个程序去做，否则硬件很容易被一些黑客程序去攻破，系统的稳定性无从谈起，因此就自然引出“特权级”的概念，最关键，最核心的一些操作智能由最高权限的程序来执行，这样就可以做到集中管理，并且能够减少有限资源的访问和使用的冲突。

以X86架构的CPU来说，它定义了一个值叫环Ring，从里到外四个环分别是Ring0，Ring1，Ring2，Ring3，也就是分别对应着四个特权级，Ring0是最高的，Ring3是最低的。CPU执行每条指令时都会对这条指令所具有的特权级做相应的检查，这样就能做到集中管理并减少资源访问使用冲突。

### 内核态与用户态
当程序运行在Ring3特权级时称为“用户态”，反之，当程序运行在Ring0特权级上的时候成为“内核态”。操作系统的代码运行在最高级别的Ring0上，而应用程序的代码运行在最低级别Ring3上。运行在用户态的程序是不能做一些底层操作的，比如需要访问磁盘，读写内存，这些操作都需要通过调用内核态的代码才能够执行。

计算虚拟化最直观的体现就是在一台服务器上同时运行多个操作系统，而这些操作系统资源池是由一个数组的操作系统和若干个客户操作系统组成的。一个服务器是无法做到同时运行多个操作系统的，因为数组操作系统是工作在内核态，而整个内核态是被数组操作系统独占的，而其它的客户操作系统就没办法使用了，但客户操作系统是不知道的，所以它以前执行什么指令，现在还是执行什么指令，但这样肯定是不行的，因为它没有权限，也就无法做的一个服务器同时运行多个操作系统。

虚拟化主要的难题就是解决多个CPU怎么虚拟的问题，因为只有多个CPU才能有多个特权级，这样才能保证每个操作系统都运行在它自己的特权级上面，所以才叫做计算虚拟化，而不是服务虚拟化。

### hypervisor（VMM）
一种运行在基础物理服务器和操作系统之间的中间软件层，可允许多个操作系统和应用共享硬件。也可叫做VMM（virtual machine monitor），即虚拟机监视器。

对于数组操作系统来说，它认为hypervisor是一个普通的运行在它上面的一个驱动程序而已，而对于客户操作系统（VM）来说，它认为它就是运行在它自己的硬件上面，也就是说所有的VM需要的硬件都是由hypervisor虚拟化提供的。

### hypervisor类型：半虚拟化
* 半虚拟化
  - 对客户操作系统（VM）的内核进行修改，将运行在Ring 0 上的指令转为调用hypervisor

虚拟化管理程序（hypervisor）有两种主要的实现方式，一是半虚拟化，设计思路是：让客户操作系统知道自己是一个虚拟机，运行在Ring3特权级上，需要把客户操作系统的内核代码进行修改，由原来的调用Ring0特权级的指令修改为调用hypervisor，这种半虚拟化只能虚拟Linux操作系统。

### hypervisor类型：全虚拟化
* 硬件复制全虚拟化
  - Intel VT和AMD-V技术
  - 客户操作系统可以直接使用Ring 0 而无需修改
  - 查看CPU是否支持：
    + grep "vmx" /proc/cpuinfo
    + grep "svm" /proc/cpuinfo

第二种实现的方式是全虚拟化，其全称为硬件辅助全虚拟化，因为只有CPU具备Intel VT或AMD-V技术才能实现虚拟化。

Vmware Workstation,VirualBox为非硬件辅助全虚拟化，其主要对CPU进行虚拟化模拟，对客户操作系统而言，它认为自己运行在自己的硬件之上。

全虚拟化的实现方式的性能大大优于半虚拟化实现方式的性能，实际生产一般采用全虚拟化的方式以实现计算虚拟化。

### 计算虚拟化的其他实现方式
* 操作系统虚拟化
  - 允许操作系统内核拥有彼此隔离和分割的多用户空间实例。这些用户空间实例，也称之为容器
  - 基于linux内核的namespace、chroot、cgroup实现

hypervisor这种计算虚拟化的实现方式可以提供包括操作系统内核在内的一个完整的系统镜像，这种技术可以为用户分配虚拟化后的CPU、内存、存储等资源，并且都是跟其它用户相互独立的，但是这种技术是一种重量级虚拟化实现技术，因为它提供了一个完整的操作系统，所有的应用都是基于这个操作系统运行的。

除了hypervisor这种重量级的虚拟化实现技术还有轻量级的虚拟化实现技术，称之为操作系统虚拟化，操作系统虚拟化允许操作系统内核拥有彼此隔离和分割的多用户空间实例，这些用户空间实例，也称之为容器。容器可以为应用程序提供一个隔离的运行空间，每个容器内都包含一个用户独享的完整的环境空间，并且对一个容器内的变动是不会影响其它容器的运行环境的。

一般基于Linux内核中的namespace实现用户空间的分割，通过chroot限制可以访问的文件，通过cgroup确定每个容器可以使用多少CPU，多少内存等系统资源。linux内核自带的有LXC容器，另外还有现在比较火的Docker，Docker还增加了一些管理功能。

### quemu
* 可以在一种架构（如PC机）下运行另一种架构（如ARM）下的操作系统和程序。
* x86架构，支持半虚拟化技术。
* 能让多个虚拟机使用同一镜像，并为每一个虚拟机配置个性化硬件环境（网卡、磁盘、图形适配器……）。
* qemu官方网站（http://www.qemu.org）.

### KVM
* KVM是开源软件，全称是kernel-based virtual machhine(基于内核的虚拟机)。
* 是x86架构且硬件支持虚拟化技术（如Intel VT或AMD-V）的linux全虚拟化解决方案。
* KVM还需要一个经过修改的QEMU软件（qemu-kvm），作为虚拟机上层控制和界面。
* KVM能让多个虚拟机使用同一镜像，并未每一个虚拟机配置个性化硬件环境（网卡、磁盘、图形适配器……）。
* 在主流的linux内核，如2.20以上的内核均已包含了KVM。

### hypervisor软件比较
![](https://github.com/Erik-ly/OpenStack-Kilo/blob/master/lesson-02/imagines/hypervisor-software.jpg)

## 2.网络虚拟化相关技术介绍



## 3.OpenStack通用组件介绍


